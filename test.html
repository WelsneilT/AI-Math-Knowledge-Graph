<script>
    // ===== D·ªÆ LI·ªÜU G·ªêC (ƒê√£ s·ª≠a BPT v√† gi·ªØ nguy√™n) =====
    const fullKnowledgeData = {
      nodes: [
        // L·ªöP 10
        { id: "M·ªánh ƒë·ªÅ v√† T·∫≠p h·ª£p", group: 10, color: '#9999ff', val: 9, type: 'chapter', description: "N·ªÅn t·∫£ng logic v√† ng√¥n ng·ªØ to√°n h·ªçc", lessons: ["M·ªánh ƒë·ªÅ", "T·∫≠p h·ª£p v√† c√°c ph√©p to√°n tr√™n t·∫≠p h·ª£p"], prerequisites: [], applications: ["B·∫•t ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n", "H√†m s·ªë v√† ƒê·ªì th·ªã", "X√°c su·∫•t c·ªï ƒëi·ªÉn", "Quan h·ªá song song (H√¨nh h·ªçc kh√¥ng gian)"] },
        { id: "B·∫•t ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n", group: 10, color: '#9999ff', val: 8, type: 'chapter', description: "X√°c ƒë·ªãnh mi·ªÅn nghi·ªám ƒë·ªÉ gi·∫£i c√°c b√†i to√°n t·ªëi ∆∞u", lessons: ["B·∫•t ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n", "H·ªá b·∫•t ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n"], prerequisites: ["M·ªánh ƒë·ªÅ v√† T·∫≠p h·ª£p"], applications: ["·ª®ng d·ª•ng ƒë·∫°o h√†m"] },
        { id: "H·ªá th·ª©c l∆∞·ª£ng trong tam gi√°c", group: 10, color: '#9999ff', val: 9, type: 'chapter', description: "ƒê·ªãnh l√Ω sin, cosin v√† c√°c h·ªá th·ª©c l∆∞·ª£ng gi√°c c∆° b·∫£n", lessons: ["Gi√° tr·ªã l∆∞·ª£ng gi√°c c·ªßa g√≥c 0¬∞-180¬∞", "H·ªá th·ª©c l∆∞·ª£ng trong tam gi√°c"], prerequisites: [], applications: ["H√†m s·ªë l∆∞·ª£ng gi√°c"] },
        { id: "Vect∆°", group: 10, color: '#9999ff', val: 10, type: 'chapter', description: "Kh√°i ni·ªám vect∆°, c√°c ph√©p to√°n v√† t√≠ch v√¥ h∆∞·ªõng", lessons: ["C√°c kh√°i ni·ªám m·ªü ƒë·∫ßu", "T·ªïng v√† hi·ªáu vect∆°", "T√≠ch vect∆° v·ªõi s·ªë", "Vect∆° trong m·∫∑t ph·∫≥ng to·∫° ƒë·ªô", "T√≠ch v√¥ h∆∞·ªõng"], prerequisites: [], applications: ["Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxy)", "Vect∆° trong kh√¥ng gian"] },
        { id: "Th·ªëng k√™ (kh√¥ng gh√©p nh√≥m)", group: 10, color: '#9999ff', val: 7, type: 'chapter', description: "C√°c s·ªë ƒë·∫∑c tr∆∞ng ƒëo xu th·∫ø trung t√¢m v√† ƒë·ªô ph√¢n t√°n", lessons: ["S·ªë g·∫ßn ƒë√∫ng v√† sai s·ªë", "S·ªë ƒë·∫∑c tr∆∞ng ƒëo xu th·∫ø trung t√¢m", "S·ªë ƒë·∫∑c tr∆∞ng ƒëo ƒë·ªô ph√¢n t√°n"], prerequisites: [], applications: ["Th·ªëng k√™ (gh√©p nh√≥m - xu th·∫ø trung t√¢m)"] },
        { id: "H√†m s·ªë v√† ƒê·ªì th·ªã", group: 10, color: '#9999ff', val: 11, type: 'chapter', description: "Kh√°i ni·ªám h√†m s·ªë, t√≠nh ch·∫•t v√† ƒë·ªì th·ªã - N·ªÅn t·∫£ng c·ªßa Gi·∫£i t√≠ch", lessons: ["H√†m s·ªë", "H√†m s·ªë b·∫≠c hai", "D·∫•u tam th·ª©c b·∫≠c hai", "Ph∆∞∆°ng tr√¨nh quy v·ªÅ b·∫≠c hai"], prerequisites: ["M·ªánh ƒë·ªÅ v√† T·∫≠p h·ª£p"], applications: ["D√£y s·ªë", "Gi·ªõi h·∫°n", "ƒê·∫°o h√†m", "H√†m s·ªë l∆∞·ª£ng gi√°c", "H√†m s·ªë m≈© v√† Logarit"] },
        { id: "Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxy)", group: 10, color: '#9999ff', val: 10, type: 'chapter', description: "ƒê·∫°i s·ªë h√≥a h√¨nh h·ªçc ph·∫≥ng b·∫±ng h·ªá to·∫° ƒë·ªô", lessons: ["Ph∆∞∆°ng tr√¨nh ƒë∆∞·ªùng th·∫≥ng", "ƒê∆∞·ªùng th·∫≥ng trong Oxy", "ƒê∆∞·ªùng tr√≤n trong Oxy", "Ba ƒë∆∞·ªùng conic"], prerequisites: ["Vect∆°"], applications: ["Vect∆° trong kh√¥ng gian", "Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxyz)"] },
        { id: "ƒê·∫°i s·ªë t·ªï h·ª£p", group: 10, color: '#9999ff', val: 9, type: 'chapter', description: "Ngh·ªá thu·∫≠t ƒë·∫øm: Ho√°n v·ªã, Ch·ªânh h·ª£p, T·ªï h·ª£p", lessons: ["Quy t·∫Øc ƒë·∫øm", "Ho√°n v·ªã, ch·ªânh h·ª£p, t·ªï h·ª£p", "Nh·ªã th·ª©c Newton"], prerequisites: [], applications: ["X√°c su·∫•t c·ªï ƒëi·ªÉn", "C√°c quy t·∫Øc t√≠nh x√°c su·∫•t", "X√°c su·∫•t c√≥ ƒëi·ªÅu ki·ªán"] },
        { id: "X√°c su·∫•t c·ªï ƒëi·ªÉn", group: 10, color: '#9999ff', val: 9, type: 'chapter', description: "ƒê·ªãnh nghƒ©a x√°c su·∫•t: P(A) = |A| / |Œ©|", lessons: ["Bi·∫øn c·ªë v√† ƒë·ªãnh nghƒ©a c·ªï ƒëi·ªÉn", "Th·ª±c h√†nh t√≠nh x√°c su·∫•t"], prerequisites: ["ƒê·∫°i s·ªë t·ªï h·ª£p", "M·ªánh ƒë·ªÅ v√† T·∫≠p h·ª£p"], applications: ["C√°c quy t·∫Øc t√≠nh x√°c su·∫•t"] },
        // L·ªöP 11
        { id: "H√†m s·ªë l∆∞·ª£ng gi√°c", group: 11, color: '#f5d442', val: 11, type: 'chapter', description: "H√†m tu·∫ßn ho√†n v√† ph∆∞∆°ng tr√¨nh l∆∞·ª£ng gi√°c", lessons: ["Gi√° tr·ªã l∆∞·ª£ng gi√°c c·ªßa g√≥c l∆∞·ª£ng gi√°c", "C√¥ng th·ª©c l∆∞·ª£ng gi√°c", "H√†m s·ªë l∆∞·ª£ng gi√°c", "Ph∆∞∆°ng tr√¨nh l∆∞·ª£ng gi√°c c∆° b·∫£n"], prerequisites: ["H·ªá th·ª©c l∆∞·ª£ng trong tam gi√°c", "H√†m s·ªë v√† ƒê·ªì th·ªã"], applications: ["ƒê·∫°o h√†m", "Nguy√™n h√†m v√† T√≠ch ph√¢n"] },
        { id: "D√£y s·ªë", group: 11, color: '#f5d442', val: 9, type: 'chapter', description: "H√†m s·ªë v·ªõi t·∫≠p x√°c ƒë·ªãnh l√† s·ªë nguy√™n d∆∞∆°ng", lessons: ["D√£y s·ªë", "C·∫•p s·ªë c·ªông", "C·∫•p s·ªë nh√¢n"], prerequisites: ["H√†m s·ªë v√† ƒê·ªì th·ªã"], applications: ["Gi·ªõi h·∫°n"] },
        { id: "Th·ªëng k√™ (gh√©p nh√≥m - xu th·∫ø trung t√¢m)", group: 11, color: '#f5d442', val: 7, type: 'chapter', description: "Th·ªëng k√™ cho d·ªØ li·ªáu gh√©p nh√≥m", lessons: ["M·∫´u s·ªë li·ªáu gh√©p nh√≥m", "S·ªë ƒë·∫∑c tr∆∞ng ƒëo xu th·∫ø trung t√¢m"], prerequisites: ["Th·ªëng k√™ (kh√¥ng gh√©p nh√≥m)"], applications: ["Th·ªëng k√™ (ƒë·ªô ph√¢n t√°n)"] },
        { id: "Quan h·ªá song song (H√¨nh h·ªçc kh√¥ng gian)", group: 11, color: '#f5d442', val: 10, type: 'chapter', description: "Quan h·ªá song song gi·ªØa ƒë∆∞·ªùng th·∫≥ng v√† m·∫∑t ph·∫≥ng", lessons: ["ƒê∆∞·ªùng th·∫≥ng v√† m·∫∑t ph·∫≥ng", "Hai ƒë∆∞·ªùng th·∫≥ng song song", "ƒê∆∞·ªùng th·∫≥ng song song m·∫∑t ph·∫≥ng", "Hai m·∫∑t ph·∫≥ng song song", "Ph√©p chi·∫øu song song"], prerequisites: ["M·ªánh ƒë·ªÅ v√† T·∫≠p h·ª£p"], applications: ["Quan h·ªá vu√¥ng g√≥c (H√¨nh h·ªçc kh√¥ng gian)", "Vect∆° trong kh√¥ng gian", "Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxyz)"] },
        { id: "Gi·ªõi h·∫°n", group: 11, color: '#f5d442', val: 11, type: 'chapter', description: "Kh√°i ni·ªám v√¥ c√πng b√© v√† v√¥ c√πng l·ªõn - N·ªÅn m√≥ng Gi·∫£i t√≠ch", lessons: ["Gi·ªõi h·∫°n c·ªßa d√£y s·ªë", "Gi·ªõi h·∫°n c·ªßa h√†m s·ªë", "H√†m s·ªë li√™n t·ª•c"], prerequisites: ["D√£y s·ªë", "H√†m s·ªë v√† ƒê·ªì th·ªã"], applications: ["ƒê·∫°o h√†m", "·ª®ng d·ª•ng ƒë·∫°o h√†m"] },
        { id: "H√†m s·ªë m≈© v√† Logarit", group: 11, color: '#f5d442', val: 10, type: 'chapter', description: "Hai l·ªõp h√†m quan tr·ªçng trong th·ª±c t·∫ø", lessons: ["L≈©y th·ª´a v·ªõi s·ªë m≈© th·ª±c", "Logarit", "H√†m s·ªë m≈© v√† logarit", "Ph∆∞∆°ng tr√¨nh, b·∫•t ph∆∞∆°ng tr√¨nh m≈© v√† logarit"], prerequisites: ["H√†m s·ªë v√† ƒê·ªì th·ªã"], applications: ["ƒê·∫°o h√†m", "Nguy√™n h√†m v√† T√≠ch ph√¢n"] },
        { id: "Quan h·ªá vu√¥ng g√≥c (H√¨nh h·ªçc kh√¥ng gian)", group: 11, color: '#f5d442', val: 11, type: 'chapter', description: "Quan h·ªá vu√¥ng g√≥c, kho·∫£ng c√°ch, g√≥c v√† th·ªÉ t√≠ch", lessons: ["Hai ƒë∆∞·ªùng th·∫≥ng vu√¥ng g√≥c", "ƒê∆∞·ªùng th·∫≥ng vu√¥ng g√≥c m·∫∑t ph·∫≥ng", "Ph√©p chi·∫øu vu√¥ng g√≥c", "Hai m·∫∑t ph·∫≥ng vu√¥ng g√≥c", "Kho·∫£ng c√°ch", "Th·ªÉ t√≠ch"], prerequisites: ["Quan h·ªá song song (H√¨nh h·ªçc kh√¥ng gian)"], applications: ["Vect∆° trong kh√¥ng gian", "Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxyz)"] },
        { id: "C√°c quy t·∫Øc t√≠nh x√°c su·∫•t", group: 11, color: '#f5d442', val: 9, type: 'chapter', description: "Bi·∫øn c·ªë h·ª£p, giao, ƒë·ªôc l·∫≠p v√† c√¥ng th·ª©c c·ªông v√† nh√¢n", lessons: ["Bi·∫øn c·ªë h·ª£p, giao, ƒë·ªôc l·∫≠p", "C√¥ng th·ª©c c·ªông x√°c su·∫•t", "C√¥ng th·ª©c nh√¢n x√°c su·∫•t"], prerequisites: ["X√°c su·∫•t c·ªï ƒëi·ªÉn", "ƒê·∫°i s·ªë t·ªï h·ª£p"], applications: ["X√°c su·∫•t c√≥ ƒëi·ªÅu ki·ªán"] },
        { id: "ƒê·∫°o h√†m", group: 11, color: '#f5d442', val: 13, type: 'chapter', description: "C√¥ng c·ª• vi ph√¢n - Tr√°i tim c·ªßa Gi·∫£i t√≠ch THPT", lessons: ["ƒê·ªãnh nghƒ©a v√† √Ω nghƒ©a", "C√°c quy t·∫Øc t√≠nh ƒë·∫°o h√†m", "ƒê·∫°o h√†m c·∫•p hai"], prerequisites: ["Gi·ªõi h·∫°n", "H√†m s·ªë v√† ƒê·ªì th·ªã", "H√†m s·ªë l∆∞·ª£ng gi√°c", "H√†m s·ªë m≈© v√† Logarit"], applications: ["·ª®ng d·ª•ng ƒë·∫°o h√†m", "Nguy√™n h√†m v√† T√≠ch ph√¢n"] },
        // L·ªöP 12
        { id: "·ª®ng d·ª•ng ƒë·∫°o h√†m", group: 12, color: '#ffd700', val: 13, type: 'chapter', description: "Kh·∫£o s√°t v√† v·∫Ω ƒë·ªì th·ªã h√†m s·ªë", lessons: ["T√≠nh ƒë∆°n ƒëi·ªáu v√† c·ª±c tr·ªã", "Gi√° tr·ªã l·ªõn nh·∫•t v√† nh·ªè nh·∫•t", "ƒê∆∞·ªùng ti·ªám c·∫≠n", "Kh·∫£o s√°t h√†m s·ªë", "·ª®ng d·ª•ng th·ª±c ti·ªÖn"], prerequisites: ["ƒê·∫°o h√†m", "Gi·ªõi h·∫°n"], applications: ["Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxyz)"] },
        { id: "Vect∆° trong kh√¥ng gian", group: 12, color: '#ff8c42', val: 10, type: 'chapter', description: "M·ªü r·ªông vect∆° t·ª´ 2D l√™n 3D", lessons: ["Vect∆° trong kh√¥ng gian", "H·ªá tr·ª•c to·∫° ƒë·ªô kh√¥ng gian", "Bi·ªÉu th·ª©c to·∫° ƒë·ªô ph√©p to√°n vect∆°"], prerequisites: ["Vect∆°", "Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxy)", "Quan h·ªá song song (H√¨nh h·ªçc kh√¥ng gian)", "Quan h·ªá vu√¥ng g√≥c (H√¨nh h·ªçc kh√¥ng gian)"], applications: ["Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxyz)"] },
        { id: "Th·ªëng k√™ (ƒë·ªô ph√¢n t√°n)", group: 12, color: '#ff8c42', val: 7, type: 'chapter', description: "Ho√†n thi·ªán Th·ªëng k√™ m√¥ t·∫£", lessons: ["Kho·∫£ng bi·∫øn thi√™n v√† t·ª© ph√¢n v·ªã", "Ph∆∞∆°ng sai v√† ƒë·ªô l·ªách chu·∫©n"], prerequisites: ["Th·ªëng k√™ (gh√©p nh√≥m - xu th·∫ø trung t√¢m)"], applications: [] },
        { id: "Nguy√™n h√†m v√† T√≠ch ph√¢n", group: 12, color: '#ffd700', val: 12, type: 'chapter', description: "Ph√©p to√°n ng∆∞·ª£c c·ªßa ƒë·∫°o h√†m", lessons: ["Nguy√™n h√†m", "T√≠ch ph√¢n", "·ª®ng d·ª•ng h√¨nh h·ªçc c·ªßa t√≠ch ph√¢n"], prerequisites: ["ƒê·∫°o h√†m", "H√†m s·ªë l∆∞·ª£ng gi√°c", "H√†m s·ªë m≈© v√† Logarit"], applications: [] },
        { id: "Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxyz)", group: 12, color: '#ff8c42', val: 14, type: 'chapter', description: "ƒê·ªânh cao c·ªßa H√¨nh h·ªçc gi·∫£i t√≠ch", lessons: ["Ph∆∞∆°ng tr√¨nh m·∫∑t ph·∫≥ng", "Ph∆∞∆°ng tr√¨nh ƒë∆∞·ªùng th·∫≥ng kh√¥ng gian", "C√¥ng th·ª©c t√≠nh g√≥c kh√¥ng gian", "Ph∆∞∆°ng tr√¨nh m·∫∑t c·∫ßu"], prerequisites: ["Vect∆° trong kh√¥ng gian", "Quan h·ªá song song (H√¨nh h·ªçc kh√¥ng gian)", "Quan h·ªá vu√¥ng g√≥c (H√¨nh h·ªçc kh√¥ng gian)", "Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô (Oxy)", "·ª®ng d·ª•ng ƒë·∫°o h√†m"], applications: [] },
        { id: "X√°c su·∫•t c√≥ ƒëi·ªÅu ki·ªán", group: 12, color: '#ff8c42', val: 9, type: 'chapter', description: "ƒê·ªânh cao c·ªßa X√°c su·∫•t THPT", lessons: ["X√°c su·∫•t c√≥ ƒëi·ªÅu ki·ªán", "C√¥ng th·ª©c x√°c su·∫•t to√†n ph·∫ßn v√† Bayes"], prerequisites: ["C√°c quy t·∫Øc t√≠nh x√°c su·∫•t", "ƒê·∫°i s·ªë t·ªï h·ª£p"], applications: [] }
      ],
      links: []
    };
    
    // ===== LOGIC T·∫†O NODE V√Ä LINK (GI·ªÆ NGUY√äN PHI√äN B·∫¢N ƒê√öNG) =====
    const lessonNodes = [];
    fullKnowledgeData.nodes.forEach(chapter => {
      if (chapter.type === 'chapter' && chapter.lessons) {
        chapter.lessons.forEach((lesson, index) => {
          lessonNodes.push({
            id: `${chapter.id}_lesson_${index}`,
            name: lesson,
            group: chapter.group,
            color: chapter.color,
            val: 3,
            type: 'lesson',
            parentChapter: chapter.id
          });
        });
      }
    });
    fullKnowledgeData.nodes.push(...lessonNodes);
    
    const nodeMap = new Map(fullKnowledgeData.nodes.map(node => [node.id, node]));
    
    fullKnowledgeData.nodes.forEach(node => {
      if (node.type === 'lesson' && node.parentChapter && nodeMap.has(node.parentChapter)) {
        fullKnowledgeData.links.push({
          source: node.parentChapter,
          target: node.id,
          type: 'sub_knowledge'
        });
      }
    });

    fullKnowledgeData.nodes.forEach(node => {
      if (node.type === 'chapter' && node.prerequisites) {
        node.prerequisites.forEach(prereqId => {
          if (nodeMap.has(prereqId)) {
            fullKnowledgeData.links.push({
              source: prereqId,
              target: node.id,
              type: "relationship"
            });
          }
        });
      }
    });

    // ===== H·ªÜ TH·ªêNG M√ÄU S·∫ÆC =====
    const NEUTRAL_COLOR = 'rgba(100, 120, 180, 0.4)';
    const PREREQUISITE_COLOR = '#ff6961';
    const APPLICATION_COLOR = '#77dd77';
    const SUB_KNOWLEDGE_COLOR = '#6CA0DC';

    // ===== TR·∫†NG TH√ÅI =====
    let selectedNode = null;
    let hoveredNode = null;
    let highlightNodes = new Set();
    let highlightLinks = new Set();
    let isNodeSelected = false;

    // C·∫≠p nh·∫≠t th·ªëng k√™
    const chapterCount = fullKnowledgeData.nodes.filter(n => n.type === 'chapter').length;
    document.getElementById('total-chapters').textContent = chapterCount;
    document.getElementById('total-links').textContent = fullKnowledgeData.links.length;

    // ===== H√ÄM T√çNH ƒê·ªò D√ÄY LINK (T·ªêI ∆ØU H√ìA) =====
    function calculateLinkWidth(link) {
      if (link.type === 'sub_knowledge') return 1;
      const sourceNode = nodeMap.get(link.source.id || link.source);
      const targetNode = nodeMap.get(link.target.id || link.target);
      if (sourceNode && targetNode && sourceNode.type === 'chapter' && targetNode.type === 'chapter') {
        const importance = (sourceNode.val + targetNode.val) / 6;
        return Math.max(2, Math.min(5, importance));
      }
      return 2;
    }

    // ===== H√ÄM X√ÅC ƒê·ªäNH M√ÄU LINK (GI·ªÆ NGUY√äN PHI√äN B·∫¢N ƒê√öNG) =====
    function getLinkColor(link) {
      const sourceId = link.source.id || link.source;
      const targetId = link.target.id || link.target;
      const currentNodeId = selectedNode ? selectedNode.id : (hoveredNode ? hoveredNode.id : null);
      
      if (!currentNodeId || !highlightLinks.has(link)) {
        if (link.type === 'sub_knowledge') return SUB_KNOWLEDGE_COLOR;
        return NEUTRAL_COLOR;
      }
      
      if (link.type === 'sub_knowledge') return SUB_KNOWLEDGE_COLOR;
      if (sourceId === currentNodeId) return APPLICATION_COLOR;
      if (targetId === currentNodeId) return PREREQUISITE_COLOR;
      
      return NEUTRAL_COLOR;
    }
    
    // ===== KH·ªûI T·∫†O GRAPH =====
    const Graph = ForceGraph3D()
      (document.getElementById('graph-container'))
        .backgroundColor('#0a0e27')
        .graphData(fullKnowledgeData)
        .nodeLabel(node => node.type === 'lesson' ? node.name : node.id)
        .nodeVal('val')
        // T·ªêI ∆ØU H√ìA S·ªê 1: CACHING ƒê·ªêI T∆Ø·ª¢NG 3D
        .nodeThreeObject(node => {
          // D√πng ƒë·ªëi t∆∞·ª£ng ƒë√£ cache n·∫øu c√≥
          if (node.threeObj) return node.threeObj;
          
          const group = new THREE.Group();
          
          // T·ªêI ∆ØU H√ìA S·ªê 2: GI·∫¢M ƒê·ªò PH·ª®C T·∫†P H√åNH H·ªåC
          const geometry = new THREE.SphereGeometry(node.val, 16, 16);
          
          // T·ªêI ∆ØU H√ìA S·ªê 3: D√ôNG V·∫¨T LI·ªÜU ƒê∆†N GI·∫¢N H∆†N
          const material = new THREE.MeshLambertMaterial({
            color: node.color,
            emissive: node.color,
            emissiveIntensity: 0.4,
            transparent: true,
            opacity: 0.95
          });
          const sphere = new THREE.Mesh(geometry, material);
          group.add(sphere);
          
          if (node.type === 'chapter' || node.type === 'lesson') {
            const sprite = new SpriteText(node.type === 'chapter' ? node.id : node.name);
            sprite.color = node.type === 'chapter' ? '#ffffff' : '#dddddd';
            sprite.textHeight = node.type === 'chapter' ? 5 : 2.5;
            sprite.fontFace = 'Arial, sans-serif';
            sprite.fontWeight = node.type === 'chapter' ? 'bold' : 'normal';
            sprite.position.y = node.val + (node.type === 'chapter' ? 8 : 4);
            group.add(sprite);
          }
          
          node.threeObj = group; // Cache ƒë·ªëi t∆∞·ª£ng
          return group;
        })
        .linkColor(link => getLinkColor(link))
        .linkWidth(link => {
          const baseWidth = calculateLinkWidth(link);
          if (highlightLinks.size === 0) return baseWidth;
          return highlightLinks.has(link) ? baseWidth * 1.5 : baseWidth * 0.3;
        })
        .linkDirectionalArrowLength(link => {
          if (link.type === 'sub_knowledge') return 3;
          if (highlightLinks.size === 0) return 6;
          return highlightLinks.has(link) ? 8 : 4;
        })
        .linkDirectionalArrowRelPos(1)
        .linkDirectionalArrowColor(link => getLinkColor(link))
        .linkOpacity(link => {
          if (highlightLinks.size === 0) return 0.6;
          return highlightLinks.has(link) ? 0.9 : 0.1;
        })
        .linkCurvature(0.2)
        .linkDirectionalParticles(link => {
          return (highlightLinks.has(link) && link.type !== 'sub_knowledge' && isNodeSelected) ? 4 : 0;
        })
        .linkDirectionalParticleWidth(3)
        .linkDirectionalParticleSpeed(0.006)
        .onNodeHover(node => {
          document.body.style.cursor = node ? 'pointer' : 'default';
          if (!isNodeSelected) {
            hoveredNode = node;
            if (node && node.type === 'chapter') {
              highlightNodeConnections(node);
            } else {
              clearHighlight();
            }
          }
        })
        .onNodeClick(node => {
          if (node.type === 'chapter') {
            isNodeSelected = true;
            selectedNode = node;
            showNodeDetail(node);
            highlightNodeConnections(node);
          }
        })
        .onBackgroundClick(() => {
          closeDetail();
          clearHighlight();
        });

    // T·ªêI ∆ØU H√ìA S·ªê 4: CHO V·∫¨T L√ù "NGH·ªà NG∆†I"
    Graph.d3AlphaDecay(0.1);

    // C·∫•u h√¨nh l·ª±c
    Graph.d3Force('charge').strength(-400);
    Graph.d3Force('link').distance(link => link.type === 'sub_knowledge' ? 30 : 120);
    Graph.d3Force('center').strength(0.2);

    // L·ª±c ph√¢n t·∫ßng (Gi·ªØ nguy√™n)
    const layerForce = (alpha) => {
      fullKnowledgeData.nodes.forEach(node => {
        let targetY = 0;
        if (node.group === 12) targetY = 150;
        else if (node.group === 11) targetY = 0;
        else if (node.group === 10) targetY = -150;
        
        node.vy -= (node.y - targetY) * 0.1 * alpha; // Gi·∫£m c∆∞·ªùng ƒë·ªô l·ª±c m·ªôt ch√∫t
      });
    };
    Graph.d3Force('layering', layerForce);

    // Th√™m √°nh s√°ng v√† m·∫∑t ph·∫≥ng (Gi·ªØ nguy√™n)
    setTimeout(() => {
      const scene = Graph.scene();
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
      directionalLight.position.set(200, 200, 200);
      scene.add(directionalLight);

      function createCirclePlane(y, label, color) {
        const radius = 400; const segments = 64;
        const geometry = new THREE.CircleGeometry(radius, segments);
        const material = new THREE.MeshBasicMaterial({ color: 0x2a2a4a, transparent: true, opacity: 0.12, side: THREE.DoubleSide });
        const circle = new THREE.Mesh(geometry, material);
        circle.position.set(0, y, 0); circle.rotation.x = Math.PI / 2;
        scene.add(circle);
        const labelSprite = new SpriteText(label);
        labelSprite.color = '#FFFFFF'; labelSprite.textHeight = 16; labelSprite.fontWeight = 'bold';
        labelSprite.position.set(radius - 50, y + 20, 0);
        scene.add(labelSprite);
        const edgesGeometry = new THREE.EdgesGeometry(geometry);
        const lineMaterial = new THREE.LineBasicMaterial({ color: color, transparent: true, opacity: 0.4, linewidth: 2 });
        const wireframe = new THREE.LineSegments(edgesGeometry, lineMaterial);
        wireframe.position.copy(circle.position); wireframe.rotation.copy(circle.rotation);
        scene.add(wireframe);
      }
      createCirclePlane(150, 'To√°n 12 - T·ªïng h·ª£p & ·ª®ng d·ª•ng', 0xff8844);
      createCirclePlane(0, 'To√°n 11 - X√¢y d·ª±ng C√¥ng c·ª•', 0xffdd44);
      createCirclePlane(-150, 'To√°n 10 - N·ªÅn t·∫£ng', 0x8888ff);
    }, 100);

    // G√≥c nh√¨n m·∫∑c ƒë·ªãnh (ƒê√£ s·ª≠a)
    setTimeout(() => {
      Graph.cameraPosition({ x: 0, y: 350, z: 800 }, { x: 0, y: 0, z: 0 }, 1500);
    }, 500);

    // ===== H√ÄM HIGHLIGHT NODE CONNECTIONS (T·ªêI ∆ØU H√ìA S·ªê 5) =====
    function highlightNodeConnections(node) {
      highlightNodes.clear();
      highlightLinks.clear();
      
      if (node) {
        highlightNodes.add(node);
        // Duy·ªát qua c√°c link c·ªßa node hi·ªáu qu·∫£ h∆°n nhi·ªÅu
        (node.links || []).forEach(link => {
          highlightLinks.add(link);
          const neighbor = (link.source === node) ? link.target : link.source;
          highlightNodes.add(neighbor);
        });
      }

      // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
      Graph.nodeThreeObject(Graph.nodeThreeObject())
         .linkColor(Graph.linkColor());
    }

    function clearHighlight() {
      highlightNodes.clear();
      highlightLinks.clear();
      isNodeSelected = false;
      hoveredNode = null;
      
      Graph.nodeThreeObject(Graph.nodeThreeObject())
         .linkColor(Graph.linkColor());
    }

    // ===== H√ÄM HI·ªÇN TH·ªä CHI TI·∫æT NODE (GI·ªÆ NGUY√äN) =====
    function showNodeDetail(node) {
      if (node.type !== 'chapter') return;
      const detail = document.getElementById('node-detail');
      const content = document.getElementById('detail-content');
      const badge = `<span class="badge badge-${node.group}">L·ªõp ${node.group}</span>`;
      let prerequisitesHTML = '';
      if (node.prerequisites && node.prerequisites.length > 0) {
        prerequisitesHTML = '<h3>üî¥ Ki·∫øn th·ª©c ti√™n quy·∫øt:</h3><ul>';
        node.prerequisites.forEach(prereq => { prerequisitesHTML += `<li>${prereq}</li>`; });
        prerequisitesHTML += '</ul>';
      }
      let applicationsHTML = '';
      if (node.applications && node.applications.length > 0) {
        applicationsHTML = '<h3>üü¢ Ki·∫øn th·ª©c ·ª©ng d·ª•ng:</h3><ul>';
        node.applications.forEach(app => { applicationsHTML += `<li>${app}</li>`; });
        applicationsHTML += '</ul>';
      }
      let lessonsHTML = '<h3>üìñ C√°c b√†i h·ªçc:</h3><ul>';
      if (node.lessons) {
        node.lessons.forEach(lesson => { lessonsHTML += `<li>${lesson}</li>`; });
      }
      lessonsHTML += '</ul>';
      content.innerHTML = `<h2>${badge} ${node.id}</h2><p style="color: #aaa; font-size: 11px; margin-bottom: 10px;">${node.description || ''}</p>${prerequisitesHTML}${applicationsHTML}${lessonsHTML}`;
      detail.classList.add('active');
    }

    function closeDetail() {
      document.getElementById('node-detail').classList.remove('active');
      selectedNode = null;
    }

    // ===== C√ÅC H√ÄM ƒêI·ªÄU KHI·ªÇN (ƒê√£ s·ª≠a `resetView` v√† `viewAngle`) =====
    function searchNode(query) {
      if (!query) { resetView(); return; }
      const found = fullKnowledgeData.nodes.find(node => node.type === 'chapter' && node.id.toLowerCase().includes(query.toLowerCase()));
      if (found) {
        isNodeSelected = true; selectedNode = found;
        highlightNodeConnections(found);
        showNodeDetail(found);
        Graph.cameraPosition({ x: found.x + 100, y: found.y + 50, z: found.z + 100 }, found, 1000);
      }
    }
    function viewAngle() { Graph.cameraPosition({ x: 0, y: 350, z: 800 }, { x: 0, y: 0, z: 0 }, 1000); }
    function viewTop() { Graph.cameraPosition({ x: 0, y: 800, z: 0 }, { x: 0, y: 0, z: 0 }, 1000); }
    function viewSide() { Graph.cameraPosition({ x: 800, y: 0, z: 0 }, { x: 0, y: 0, z: 0 }, 1000); }
    function resetView() {
      closeDetail(); clearHighlight();
      document.getElementById('search-input').value = '';
      viewAngle();
    }
    let physicsEnabled = true;
    function togglePhysics() {
      physicsEnabled = !physicsEnabled;
      if (physicsEnabled) { Graph.d3ReheatSimulation(); Graph.d3AlphaDecay(0.1); } 
      else { Graph.d3AlphaDecay(1); }
    }
  </script>
</body>
</html>