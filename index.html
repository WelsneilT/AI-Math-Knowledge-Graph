<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒê·ªì th·ªã Ki·∫øn th·ª©c To√°n THPT 3D - Tr·∫£i nghi·ªám Trung t√≠nh & G·ª£i m·ªü</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0a0e27;
      color: #fff;
      overflow: hidden; 
    }
    
    #graph-container {
      width: 100vw;
      height: 100vh;
    }
    
    .panel {
      position: absolute;
      background-color: rgba(20, 25, 45, 0.95);
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid rgba(100, 150, 255, 0.4);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      z-index: 1000;
    }
    
    .info {
      top: 10px;
      left: 10px;
      max-width: 160px;
    }
    
    .info h3 { 
      margin: 0 0 8px 0;
      font-size: 12px;
      color: #6ca0dc;
      border-bottom: 2px solid rgba(108, 160, 220, 0.3);
      padding-bottom: 4px;
    }
    
    .legend-item { 
      display: flex; 
      align-items: center; 
      margin-bottom: 6px;
      font-size: 10px;
      transition: transform 0.2s;
    }
    
    .legend-item:hover {
      transform: translateX(3px);
    }
    
    .legend-color { 
      width: 25px; 
      height: 3px; 
      margin-right: 8px;
      border-radius: 2px;
      box-shadow: 0 0 8px currentColor;
    }
    
    .legend-note {
      font-size: 9px;
      color: #888;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(100, 150, 255, 0.2);
      font-style: italic;
    }
    
    /* SEARCH BOX - Ph·∫£i tr√™n c√πng */
    .search-box {
      top: 10px;
      right: 10px;
      min-width: 320px;
      max-width: 320px;
      padding: 10px 12px;
    }
    
    .search-box h3 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: #6ca0dc;
      border-bottom: 2px solid rgba(108, 160, 220, 0.3);
      padding-bottom: 4px;
    }
    
    .search-box input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid rgba(100, 150, 255, 0.4);
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 12px;
    }
    
    .search-box input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    /* CONTROLS - G√≥c ph·∫£i d∆∞·ªõi, 5 n√∫t 1 h√†ng ngang */
    .controls {
      bottom: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      padding: 10px;
    }
    
    .controls button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.3s;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .controls button:active {
      transform: translateY(0);
    }
    
    .instructions {
      bottom: 10px;
      left: 10px;
      font-size: 10px;
      color: #aaa;
      max-width: 350px;
      line-height: 1.5;
    }
    
    .instructions strong {
      color: #6ca0dc;
    }
    
    .node-detail {
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      max-width: 320px;
      min-width: 320px;
      max-height: 70vh;
      overflow-y: auto;
      display: none;
    }
    
    .node-detail.active {
      display: block;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-50%) translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
      }
    }
    
    .node-detail h2 {
      font-size: 15px;
      margin-bottom: 10px;
      color: #ffd700;
      border-bottom: 2px solid rgba(255, 215, 0, 0.3);
      padding-bottom: 5px;
    }
    
    .node-detail h3 {
      font-size: 13px;
      margin: 12px 0 6px 0;
      color: #6ca0dc;
    }
    
    .node-detail ul {
      list-style: none;
      padding-left: 0;
    }
    
    .node-detail li {
      margin: 6px 0;
      padding-left: 15px;
      position: relative;
      font-size: 11px;
      line-height: 1.5;
    }
    
    .node-detail li:before {
      content: "‚ñ∏";
      position: absolute;
      left: 3px;
      color: #6ca0dc;
    }
    
    .close-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      transition: all 0.3s;
    }
    
    .close-btn:hover {
      background: rgba(255, 100, 100, 0.8);
      transform: rotate(90deg);
    }
    
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: bold;
      margin-right: 3px;
    }
    
    .badge-10 { background: #9999ff; }
    .badge-11 { background: #f5d442; color: #000; }
    .badge-12 { background: #ff8c42; }
    
    ::-webkit-scrollbar {
      width: 5px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(108, 160, 220, 0.5);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(108, 160, 220, 0.8);
    }

    .stats {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(100, 150, 255, 0.3);
      font-size: 10px;
      color: #aaa;
    }

    .stat-item {
      margin: 3px 0;
    }

    .stat-number {
      color: #6ca0dc;
      font-weight: bold;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div id="graph-container"></div>

  <div class="panel info">
    <h3>üìö Ch√∫ th√≠ch</h3>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #ff6961;"></div>
      <span>Ki·∫øn th·ª©c ti√™n quy·∫øt</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #6CA0DC;"></div>
      <span>Ph√¢n r√£ ki·∫øn th·ª©c</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #77dd77;"></div>
      <span>Ki·∫øn th·ª©c ·ª©ng d·ª•ng</span>
    </div>
    <div class="legend-note">
     <strong>Hover</strong> ƒë·ªÉ xem tr∆∞·ªõc<br>
    <strong>Click</strong> ƒë·ªÉ c·ªë ƒë·ªãnh
    </div>
    <div class="stats">
      <div class="stat-item">Ch∆∞∆°ng: <span class="stat-number" id="total-chapters">0</span></div>
      <div class="stat-item">Li√™n k·∫øt: <span class="stat-number" id="total-links">0</span></div>
    </div>
  </div>

  <div class="panel search-box">
    <h3> T√¨m ki·∫øm</h3>
    <input type="text" id="search-input" placeholder="Nh·∫≠p t√™n ch∆∞∆°ng ƒë·ªÉ t√¨m ki·∫øm..." oninput="searchNode(this.value)">
  </div>

  <div class="panel controls">
    <button onclick="viewAngle()">G√≥c nghi√™ng</button>
    <button onclick="viewTop()">T·ª´ tr√™n xu·ªëng</button>
    <button onclick="viewSide()">G√≥c ngang</button>
    <button onclick="resetView()">ƒê·∫∑t l·∫°i</button>
    <button onclick="togglePhysics()">V·∫≠t l√Ω</button>
</div>

  <div class="panel instructions">
    <strong>K√©o:</strong> Xoay | <strong>Scroll:</strong> Zoom | <strong>Ph·∫£i:</strong> Di chuy·ªÉn<br>
    <strong>Hover node:</strong> Xem tr∆∞·ªõc li√™n k·∫øt | <strong>Click:</strong> Xem chi ti·∫øt & c·ªë ƒë·ªãnh m√†u
  </div>

  <div class="panel node-detail" id="node-detail">
    <button class="close-btn" onclick="closeDetail()">√ó</button>
    <div id="detail-content"></div>
  </div>

  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three-spritetext@1.8.2/dist/three-spritetext.min.js"></script>
  <script src="https://unpkg.com/3d-force-graph@1.73.3/dist/3d-force-graph.min.js"></script>

  <script>
    const fullKnowledgeData = {
  nodes: [
    // L·ªöP 10
    { id: "CH∆Ø∆†NG I. M·ªÜNH ƒê·ªÄ V√Ä T·∫¨P H·ª¢P", group: 10, color: '#9999ff', val: 9, type: 'chapter', description: "N·ªÅn t·∫£ng logic v√† ng√¥n ng·ªØ to√°n h·ªçc", lessons: ["M·ªánh ƒë·ªÅ", "T·∫≠p h·ª£p v√† c√°c ph√©p to√°n tr√™n t·∫≠p h·ª£p"], prerequisites: [], applications: ["CH∆Ø∆†NG II. B·∫§T PH∆Ø∆†NG TR√åNH V√Ä H·ªÜ B·∫§T PH∆Ø∆†NG TR√åNH B·∫¨C NH·∫§T HAI ·∫®N", "CH∆Ø∆†NG VI. H√ÄM S·ªê, ƒê·ªí TH·ªä V√Ä ·ª®NG D·ª§NG", "CH∆Ø∆†NG IX. T√çNH X√ÅC SU·∫§T THEO ƒê·ªäNH NGHƒ®A C·ªî ƒêI·ªÇN", "CH∆Ø∆†NG IV. QUAN H·ªÜ SONG SONG TRONG KH√îNG GIAN"] },
    { id: "CH∆Ø∆†NG II. B·∫§T PH∆Ø∆†NG TR√åNH V√Ä H·ªÜ B·∫§T PH∆Ø∆†NG TR√åNH B·∫¨C NH·∫§T HAI ·∫®N", group: 10, color: '#9999ff', val: 8, type: 'chapter', description: "Gi·∫£i b·∫•t ph∆∞∆°ng tr√¨nh v√† h·ªá b·∫•t ph∆∞∆°ng tr√¨nh trong kh√¥ng gian 2D", lessons: ["B·∫•t ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n", "H·ªá b·∫•t ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n"], prerequisites: ["CH∆Ø∆†NG I. M·ªÜNH ƒê·ªÄ V√Ä T·∫¨P H·ª¢P"], applications: ["CH∆Ø∆†NG I. ·ª®NG D·ª§NG ƒê·∫†O H√ÄM ƒê·ªÇ KH·∫¢O S√ÅT V√Ä V·∫º ƒê·ªí TH·ªä H√ÄM S·ªê"] },
    { id: "CH∆Ø∆†NG III. H·ªÜ TH·ª®C L∆Ø·ª¢NG TRONG TAM GI√ÅC", group: 10, color: '#9999ff', val: 9, type: 'chapter', description: "ƒê·ªãnh l√Ω sin, cosin v√† c√°c h·ªá th·ª©c l∆∞·ª£ng gi√°c c∆° b·∫£n", lessons: ["Gi√° tr·ªã l∆∞·ª£ng gi√°c c·ªßa g√≥c 0¬∞-180¬∞", "H·ªá th·ª©c l∆∞·ª£ng trong tam gi√°c"], prerequisites: [], applications: ["CH∆Ø∆†NG I. H√ÄM S·ªê L∆Ø·ª¢NG GI√ÅC V√Ä PH∆Ø∆†NG TR√åNH L∆Ø·ª¢NG GI√ÅC"] },
    { id: "CH∆Ø∆†NG IV. VECTO", group: 10, color: '#9999ff', val: 10, type: 'chapter', description: "Kh√°i ni·ªám vect∆°, c√°c ph√©p to√°n v√† t√≠ch v√¥ h∆∞·ªõng", lessons: ["C√°c kh√°i ni·ªám m·ªü ƒë·∫ßu", "T·ªïng v√† hi·ªáu vect∆°", "T√≠ch vect∆° v·ªõi s·ªë", "Vect∆° trong m·∫∑t ph·∫≥ng to·∫° ƒë·ªô", "T√≠ch v√¥ h∆∞·ªõng"], prerequisites: [], applications: ["CH∆Ø∆†NG VII. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG M·∫∂T PH·∫≤NG", "CH∆Ø∆†NG II. VECT∆† V√Ä H·ªÜ TR·ª§C TO·∫† ƒê·ªò TRONG KH√îNG GIAN"] },
    { id: "CH∆Ø∆†NG V. C√ÅC S·ªê ƒê·∫∂C TR∆ØNG C·ª¶A M·∫™U S·ªê LI·ªÜU KH√îNG GH√âP NH√ìM", group: 10, color: '#9999ff', val: 7, type: 'chapter', description: "C√°c s·ªë ƒë·∫∑c tr∆∞ng ƒëo xu th·∫ø trung t√¢m v√† ƒë·ªô ph√¢n t√°n", lessons: ["S·ªë g·∫ßn ƒë√∫ng v√† sai s·ªë", "S·ªë ƒë·∫∑c tr∆∞ng ƒëo xu th·∫ø trung t√¢m", "S·ªë ƒë·∫∑c tr∆∞ng ƒëo ƒë·ªô ph√¢n t√°n"], prerequisites: [], applications: ["CH∆Ø∆†NG III. C√ÅC S·ªê ƒê·∫∂C TR∆ØNG ƒêO XU TH·∫æ TRUNG T√ÇM C·ª¶A M·∫™U S·ªê LI·ªÜU GH√âP NH√ìM"] },
    { id: "CH∆Ø∆†NG VI. H√ÄM S·ªê, ƒê·ªí TH·ªä V√Ä ·ª®NG D·ª§NG", group: 10, color: '#9999ff', val: 11, type: 'chapter', description: "Kh√°i ni·ªám h√†m s·ªë, t√≠nh ch·∫•t v√† ƒë·ªì th·ªã - N·ªÅn t·∫£ng c·ªßa Gi·∫£i t√≠ch", lessons: ["H√†m s·ªë", "H√†m s·ªë b·∫≠c hai", "D·∫•u tam th·ª©c b·∫≠c hai", "Ph∆∞∆°ng tr√¨nh quy v·ªÅ b·∫≠c hai"], prerequisites: ["CH∆Ø∆†NG I. M·ªÜNH ƒê·ªÄ V√Ä T·∫¨P H·ª¢P"], applications: ["CH∆Ø∆†NG II. D√ÉY S·ªê. C·∫§P S·ªê C·ªòNG V√Ä C·∫§P S·ªê NH√ÇN", "CH∆Ø∆†NG V. GI·ªöI H·∫†N. H√ÄM S·ªê LI√äN T·ª§C", "CH∆Ø∆†NG IX. ƒê·∫†O H√ÄM", "CH∆Ø∆†NG I. H√ÄM S·ªê L∆Ø·ª¢NG GI√ÅC V√Ä PH∆Ø∆†NG TR√åNH L∆Ø·ª¢NG GI√ÅC", "CH∆Ø∆†NG VI. H√ÄM S·ªê M≈® V√Ä H√ÄM S·ªê L√îGARIT"] },
    { id: "CH∆Ø∆†NG VII. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG M·∫∂T PH·∫≤NG", group: 10, color: '#9999ff', val: 10, type: 'chapter', description: "ƒê·∫°i s·ªë h√≥a h√¨nh h·ªçc ph·∫≥ng b·∫±ng h·ªá to·∫° ƒë·ªô", lessons: ["Ph∆∞∆°ng tr√¨nh ƒë∆∞·ªùng th·∫≥ng", "ƒê∆∞·ªùng th·∫≥ng trong Oxy", "ƒê∆∞·ªùng tr√≤n trong Oxy", "Ba ƒë∆∞·ªùng conic"], prerequisites: ["CH∆Ø∆†NG IV. VECTO"], applications: ["CH∆Ø∆†NG II. VECT∆† V√Ä H·ªÜ TR·ª§C TO·∫† ƒê·ªò TRONG KH√îNG GIAN", "CH∆Ø∆†NG V. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG KH√îNG GIAN"] },
    { id: "CH∆Ø∆†NH VIII. ƒê·∫†I S·ªê T·ªî H·ª¢P", group: 10, color: '#9999ff', val: 9, type: 'chapter', description: "Ngh·ªá thu·∫≠t ƒë·∫øm: Ho√°n v·ªã, Ch·ªânh h·ª£p, T·ªï h·ª£p", lessons: ["Quy t·∫Øc ƒë·∫øm", "Ho√°n v·ªã, ch·ªânh h·ª£p, t·ªï h·ª£p", "Nh·ªã th·ª©c Newton"], prerequisites: [], applications: ["CH∆Ø∆†NG IX. T√çNH X√ÅC SU·∫§T THEO ƒê·ªäNH NGHƒ®A C·ªî ƒêI·ªÇN", "CH∆Ø∆†NG VIII. C√ÅC QUY T·∫ÆC T√çNH X√ÅC SU·∫§T", "CH∆Ø∆†NG VI. X√ÅC SU·∫§T C√ì ƒêI·ªÄU KI·ªÜN"] },
    { id: "CH∆Ø∆†NG IX. T√çNH X√ÅC SU·∫§T THEO ƒê·ªäNH NGHƒ®A C·ªî ƒêI·ªÇN", group: 10, color: '#9999ff', val: 9, type: 'chapter', description: "ƒê·ªãnh nghƒ©a x√°c su·∫•t: P(A) = |A| / |Œ©|", lessons: ["Bi·∫øn c·ªë v√† ƒë·ªãnh nghƒ©a c·ªï ƒëi·ªÉn", "Th·ª±c h√†nh t√≠nh x√°c su·∫•t"], prerequisites: ["CH∆Ø∆†NH VIII. ƒê·∫†I S·ªê T·ªî H·ª¢P", "CH∆Ø∆†NG I. M·ªÜNH ƒê·ªÄ V√Ä T·∫¨P H·ª¢P"], applications: ["CH∆Ø∆†NG VIII. C√ÅC QUY T·∫ÆC T√çNH X√ÅC SU·∫§T"] },
    
    // L·ªöP 11
    { id: "CH∆Ø∆†NG I. H√ÄM S·ªê L∆Ø·ª¢NG GI√ÅC V√Ä PH∆Ø∆†NG TR√åNH L∆Ø·ª¢NG GI√ÅC", group: 11, color: '#f5d442', val: 11, type: 'chapter', description: "H√†m tu·∫ßn ho√†n v√† ph∆∞∆°ng tr√¨nh l∆∞·ª£ng gi√°c", lessons: ["Gi√° tr·ªã l∆∞·ª£ng gi√°c c·ªßa g√≥c l∆∞·ª£ng gi√°c", "C√¥ng th·ª©c l∆∞·ª£ng gi√°c", "H√†m s·ªë l∆∞·ª£ng gi√°c", "Ph∆∞∆°ng tr√¨nh l∆∞·ª£ng gi√°c c∆° b·∫£n"], prerequisites: ["CH∆Ø∆†NG III. H·ªÜ TH·ª®C L∆Ø·ª¢NG TRONG TAM GI√ÅC", "CH∆Ø∆†NG VI. H√ÄM S·ªê, ƒê·ªí TH·ªä V√Ä ·ª®NG D·ª§NG"], applications: ["CH∆Ø∆†NG IX. ƒê·∫†O H√ÄM", "CH∆Ø∆†NG IV. NGUY√äN H√ÄM V√Ä T√çCH PH√ÇN"] },
    { id: "CH∆Ø∆†NG II. D√ÉY S·ªê. C·∫§P S·ªê C·ªòNG V√Ä C·∫§P S·ªê NH√ÇN", group: 11, color: '#f5d442', val: 9, type: 'chapter', description: "H√†m s·ªë v·ªõi t·∫≠p x√°c ƒë·ªãnh l√† s·ªë nguy√™n d∆∞∆°ng", lessons: ["D√£y s·ªë", "C·∫•p s·ªë c·ªông", "C·∫•p s·ªë nh√¢n"], prerequisites: ["CH∆Ø∆†NG VI. H√ÄM S·ªê, ƒê·ªí TH·ªä V√Ä ·ª®NG D·ª§NG"], applications: ["CH∆Ø∆†NG V. GI·ªöI H·∫†N. H√ÄM S·ªê LI√äN T·ª§C"] },
    { id: "CH∆Ø∆†NG III. C√ÅC S·ªê ƒê·∫∂C TR∆ØNG ƒêO XU TH·∫æ TRUNG T√ÇM C·ª¶A M·∫™U S·ªê LI·ªÜU GH√âP NH√ìM", group: 11, color: '#f5d442', val: 7, type: 'chapter', description: "Th·ªëng k√™ cho d·ªØ li·ªáu gh√©p nh√≥m", lessons: ["M·∫´u s·ªë li·ªáu gh√©p nh√≥m", "S·ªë ƒë·∫∑c tr∆∞ng ƒëo xu th·∫ø trung t√¢m"], prerequisites: ["CH∆Ø∆†NG V. C√ÅC S·ªê ƒê·∫∂C TR∆ØNG C·ª¶A M·∫™U S·ªê LI·ªÜU KH√îNG GH√âP NH√ìM"], applications: ["CH∆Ø∆†NG III. C√ÅC S·ªê ƒê·∫∂C TR∆ØNG ƒêO M·ª®C ƒê·ªò PH√ÇN T√ÅN C·ª¶A M·∫™U S·ªê LI·ªÜU GH√âP NH√ìM"] },
    {
        "id": "CH∆Ø∆†NG IV. QUAN H·ªÜ SONG SONG TRONG KH√îNG GIAN",
        "group": 11,
        "color": "#f5d442",
        "val": 10,
        "type": "chapter",
        "description": "Quan h·ªá song song gi·ªØa ƒë∆∞·ªùng th·∫≥ng v√† m·∫∑t ph·∫≥ng",
        "lessons": ["ƒê∆∞·ªùng th·∫≥ng v√† m·∫∑t ph·∫≥ng", "Hai ƒë∆∞·ªùng th·∫≥ng song song", "ƒê∆∞·ªùng th·∫≥ng song song m·∫∑t ph·∫≥ng", "Hai m·∫∑t ph·∫≥ng song song", "Ph√©p chi·∫øu song song"],
        "prerequisites": ["CH∆Ø∆†NG IV. VECTO", "CH∆Ø∆†NG VII. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG M·∫∂T PH·∫≤NG"],
        "applications": ["CH∆Ø∆†NG VII. QUAN H·ªÜ VU√îNG G√ìC TRONG KH√îNG GIAN", "CH∆Ø∆†NG II. VECT∆† V√Ä H·ªÜ TR·ª§C TO·∫† ƒê·ªò TRONG KH√îNG GIAN", "CH∆Ø∆†NG V. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG KH√îNG GIAN"]
    },
    { id: "CH∆Ø∆†NG V. GI·ªöI H·∫†N. H√ÄM S·ªê LI√äN T·ª§C", group: 11, color: '#f5d442', val: 11, type: 'chapter', description: "Kh√°i ni·ªám v√¥ c√πng b√© v√† v√¥ c√πng l·ªõn - N·ªÅn m√≥ng Gi·∫£i t√≠ch", lessons: ["Gi·ªõi h·∫°n c·ªßa d√£y s·ªë", "Gi·ªõi h·∫°n c·ªßa h√†m s·ªë", "H√†m s·ªë li√™n t·ª•c"], prerequisites: ["CH∆Ø∆†NG II. D√ÉY S·ªê. C·∫§P S·ªê C·ªòNG V√Ä C·∫§P S·ªê NH√ÇN", "CH∆Ø∆†NG VI. H√ÄM S·ªê, ƒê·ªí TH·ªä V√Ä ·ª®NG D·ª§NG"], applications: ["CH∆Ø∆†NG IX. ƒê·∫†O H√ÄM", "CH∆Ø∆†NG I. ·ª®NG D·ª§NG ƒê·∫†O H√ÄM ƒê·ªÇ KH·∫¢O S√ÅT V√Ä V·∫º ƒê·ªí TH·ªä H√ÄM S·ªê"] },
    { id: "CH∆Ø∆†NG VI. H√ÄM S·ªê M≈® V√Ä H√ÄM S·ªê L√îGARIT", group: 11, color: '#f5d442', val: 10, type: 'chapter', description: "Hai l·ªõp h√†m quan tr·ªçng trong th·ª±c t·∫ø", lessons: ["L≈©y th·ª´a v·ªõi s·ªë m≈© th·ª±c", "Logarit", "H√†m s·ªë m≈© v√† logarit", "Ph∆∞∆°ng tr√¨nh, b·∫•t ph∆∞∆°ng tr√¨nh m≈© v√† logarit"], prerequisites: ["CH∆Ø∆†NG VI. H√ÄM S·ªê, ƒê·ªí TH·ªä V√Ä ·ª®NG D·ª§NG"], applications: ["CH∆Ø∆†NG IX. ƒê·∫†O H√ÄM", "CH∆Ø∆†NG IV. NGUY√äN H√ÄM V√Ä T√çCH PH√ÇN"] },
    { id: "CH∆Ø∆†NG VII. QUAN H·ªÜ VU√îNG G√ìC TRONG KH√îNG GIAN", group: 11, color: '#f5d442', val: 11, type: 'chapter', description: "Quan h·ªá vu√¥ng g√≥c, kho·∫£ng c√°ch, g√≥c v√† th·ªÉ t√≠ch", lessons: ["Hai ƒë∆∞·ªùng th·∫≥ng vu√¥ng g√≥c", "ƒê∆∞·ªùng th·∫≥ng vu√¥ng g√≥c m·∫∑t ph·∫≥ng", "Ph√©p chi·∫øu vu√¥ng g√≥c", "Hai m·∫∑t ph·∫≥ng vu√¥ng g√≥c", "Kho·∫£ng c√°ch", "Th·ªÉ t√≠ch"], prerequisites: ["CH∆Ø∆†NG IV. QUAN H·ªÜ SONG SONG TRONG KH√îNG GIAN"], applications: ["CH∆Ø∆†NG II. VECT∆† V√Ä H·ªÜ TR·ª§C TO·∫† ƒê·ªò TRONG KH√îNG GIAN", "CH∆Ø∆†NG V. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG KH√îNG GIAN"] },
    { id: "CH∆Ø∆†NG VIII. C√ÅC QUY T·∫ÆC T√çNH X√ÅC SU·∫§T", group: 11, color: '#f5d442', val: 9, type: 'chapter', description: "Bi·∫øn c·ªë h·ª£p, giao, ƒë·ªôc l·∫≠p v√† c√¥ng th·ª©c c·ªông v√† nh√¢n", lessons: ["Bi·∫øn c·ªë h·ª£p, giao, ƒë·ªôc l·∫≠p", "C√¥ng th·ª©c c·ªông x√°c su·∫•t", "C√¥ng th·ª©c nh√¢n x√°c su·∫•t"], prerequisites: ["CH∆Ø∆†NG IX. T√çNH X√ÅC SU·∫§T THEO ƒê·ªäNH NGHƒ®A C·ªî ƒêI·ªÇN", "CH∆Ø∆†NH VIII. ƒê·∫†I S·ªê T·ªî H·ª¢P"], applications: ["CH∆Ø∆†NG VI. X√ÅC SU·∫§T C√ì ƒêI·ªÄU KI·ªÜN"] },
    { id: "CH∆Ø∆†NG IX. ƒê·∫†O H√ÄM", group: 11, color: '#f5d442', val: 13, type: 'chapter', description: "C√¥ng c·ª• vi ph√¢n - Tr√°i tim c·ªßa Gi·∫£i t√≠ch THPT", lessons: ["ƒê·ªãnh nghƒ©a v√† √Ω nghƒ©a", "C√°c quy t·∫Øc t√≠nh ƒë·∫°o h√†m", "ƒê·∫°o h√†m c·∫•p hai"], prerequisites: ["CH∆Ø∆†NG V. GI·ªöI H·∫†N. H√ÄM S·ªê LI√äN T·ª§C", "CH∆Ø∆†NG VI. H√ÄM S·ªê, ƒê·ªí TH·ªä V√Ä ·ª®NG D·ª§NG", "CH∆Ø∆†NG I. H√ÄM S·ªê L∆Ø·ª¢NG GI√ÅC V√Ä PH∆Ø∆†NG TR√åNH L∆Ø·ª¢NG GI√ÅC", "CH∆Ø∆†NG VI. H√ÄM S·ªê M≈® V√Ä H√ÄM S·ªê L√îGARIT"], applications: ["CH∆Ø∆†NG I. ·ª®NG D·ª§NG ƒê·∫†O H√ÄM ƒê·ªÇ KH·∫¢O S√ÅT V√Ä V·∫º ƒê·ªí TH·ªä H√ÄM S·ªê", "CH∆Ø∆†NG IV. NGUY√äN H√ÄM V√Ä T√çCH PH√ÇN"] },
    
    // L·ªöP 12
    { id: "CH∆Ø∆†NG I. ·ª®NG D·ª§NG ƒê·∫†O H√ÄM ƒê·ªÇ KH·∫¢O S√ÅT V√Ä V·∫º ƒê·ªí TH·ªä H√ÄM S·ªê", group: 12, color: '#ffd700', val: 13, type: 'chapter', description: "Kh·∫£o s√°t v√† v·∫Ω ƒë·ªì th·ªã h√†m s·ªë", lessons: ["T√≠nh ƒë∆°n ƒëi·ªáu v√† c·ª±c tr·ªã", "Gi√° tr·ªã l·ªõn nh·∫•t v√† nh·ªè nh·∫•t", "ƒê∆∞·ªùng ti·ªám c·∫≠n", "Kh·∫£o s√°t h√†m s·ªë", "·ª®ng d·ª•ng th·ª±c ti·ªÖn"], prerequisites: ["CH∆Ø∆†NG IX. ƒê·∫†O H√ÄM", "CH∆Ø∆†NG V. GI·ªöI H·∫†N. H√ÄM S·ªê LI√äN T·ª§C"], applications: ["CH∆Ø∆†NG V. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG KH√îNG GIAN"] },
    { id: "CH∆Ø∆†NG II. VECT∆† V√Ä H·ªÜ TR·ª§C TO·∫† ƒê·ªò TRONG KH√îNG GIAN", group: 12, color: '#ff8c42', val: 10, type: 'chapter', description: "M·ªü r·ªông vect∆° t·ª´ 2D l√™n 3D", lessons: ["Vect∆° trong kh√¥ng gian", "H·ªá tr·ª•c to·∫° ƒë·ªô trong kh√¥ng gian", "Bi·ªÉu th·ª©c to·∫° ƒë·ªô c·ªßa c√°c ph√©p to√°n vect∆°"], prerequisites: ["CH∆Ø∆†NG IV. VECTO", "CH∆Ø∆†NG VII. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG M·∫∂T PH·∫≤NG", "CH∆Ø∆†NG IV. QUAN H·ªÜ SONG SONG TRONG KH√îNG GIAN", "CH∆Ø∆†NG VII. QUAN H·ªÜ VU√îNG G√ìC TRONG KH√îNG GIAN"], applications: ["CH∆Ø∆†NG V. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG KH√îNG GIAN"] },
    { id: "CH∆Ø∆†NG III. C√ÅC S·ªê ƒê·∫∂C TR∆ØNG ƒêO M·ª®C ƒê·ªò PH√ÇN T√ÅN C·ª¶A M·∫™U S·ªê LI·ªÜU GH√âP NH√ìM", group: 12, color: '#ff8c42', val: 7, type: 'chapter', description: "Ho√†n thi·ªán Th·ªëng k√™ m√¥ t·∫£", lessons: ["Kho·∫£ng bi·∫øn thi√™n v√† kho·∫£ng t·ª© ph√¢n v·ªã", "Ph∆∞∆°ng sai v√† ƒë·ªô l·ªách chu·∫©n"], prerequisites: ["CH∆Ø∆†NG III. C√ÅC S·ªê ƒê·∫∂C TR∆ØNG ƒêO XU TH·∫æ TRUNG T√ÇM C·ª¶A M·∫™U S·ªê LI·ªÜU GH√âP NH√ìM"], applications: [] },
    { id: "CH∆Ø∆†NG IV. NGUY√äN H√ÄM V√Ä T√çCH PH√ÇN", group: 12, color: '#ffd700', val: 12, type: 'chapter', description: "Ph√©p to√°n ng∆∞·ª£c c·ªßa ƒë·∫°o h√†m", lessons: ["Nguy√™n h√†m", "T√≠ch ph√¢n", "·ª®ng d·ª•ng h√¨nh h·ªçc c·ªßa t√≠ch ph√¢n"], prerequisites: ["CH∆Ø∆†NG IX. ƒê·∫†O H√ÄM", "CH∆Ø∆†NG I. H√ÄM S·ªê L∆Ø·ª¢NG GI√ÅC V√Ä PH∆Ø∆†NG TR√åNH L∆Ø·ª¢NG GI√ÅC", "CH∆Ø∆†NG VI. H√ÄM S·ªê M≈® V√Ä H√ÄM S·ªê L√îGARIT"], applications: [] },
    { id: "CH∆Ø∆†NG V. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG KH√îNG GIAN", group: 12, color: '#ff8c42', val: 14, type: 'chapter', description: "ƒê·ªânh cao c·ªßa H√¨nh h·ªçc gi·∫£i t√≠ch", lessons: ["Ph∆∞∆°ng tr√¨nh m·∫∑t ph·∫≥ng", "Ph∆∞∆°ng tr√¨nh ƒë∆∞·ªùng th·∫≥ng trong kh√¥ng gian", "C√¥ng th·ª©c t√≠nh g√≥c trong kh√¥ng gian", "Ph∆∞∆°ng tr√¨nh m·∫∑t c·∫ßu"], prerequisites: ["CH∆Ø∆†NG II. VECT∆† V√Ä H·ªÜ TR·ª§C TO·∫† ƒê·ªò TRONG KH√îNG GIAN", "CH∆Ø∆†NG IV. QUAN H·ªÜ SONG SONG TRONG KH√îNG GIAN", "CH∆Ø∆†NG VII. QUAN H·ªÜ VU√îNG G√ìC TRONG KH√îNG GIAN", "CH∆Ø∆†NG VII. PH∆Ø∆†NG PH√ÅP TO·∫† ƒê·ªò TRONG M·∫∂T PH·∫≤NG", "CH∆Ø∆†NG I. ·ª®NG D·ª§NG ƒê·∫†O H√ÄM ƒê·ªÇ KH·∫¢O S√ÅT V√Ä V·∫º ƒê·ªí TH·ªä H√ÄM S·ªê"], applications: [] },
    { id: "CH∆Ø∆†NG VI. X√ÅC SU·∫§T C√ì ƒêI·ªÄU KI·ªÜN", group: 12, color: '#ff8c42', val: 9, type: 'chapter', description: "ƒê·ªânh cao c·ªßa X√°c su·∫•t THPT", lessons: ["X√°c su·∫•t c√≥ ƒëi·ªÅu ki·ªán", "C√¥ng th·ª©c x√°c su·∫•t to√†n ph·∫ßn v√† c√¥ng th·ª©c Bayes"], prerequisites: ["CH∆Ø∆†NG VIII. C√ÅC QUY T·∫ÆC T√çNH X√ÅC SU·∫§T", "CH∆Ø∆†NH VIII. ƒê·∫†I S·ªê T·ªî H·ª¢P"], applications: [] }
  ],
  links: []
};
    
    // Th√™m c√°c node b√†i h·ªçc (lessons) v√†o graph
    const lessonNodes = [];
    fullKnowledgeData.nodes.forEach(chapter => {
      if (chapter.type === 'chapter' && chapter.lessons) {
        chapter.lessons.forEach((lesson, index) => {
          lessonNodes.push({
            id: `${chapter.id}_lesson_${index}`, // ID duy nh·∫•t cho b√†i h·ªçc
            name: lesson,
            group: chapter.group,
            color: chapter.color,
            val: 3, // K√≠ch th∆∞·ªõc nh·ªè h∆°n cho node b√†i h·ªçc
            type: 'lesson',
            parentChapter: chapter.id
          });
        });
      }
    });

    // B∆∞·ªõc 2: Th√™m c√°c node b√†i h·ªçc v·ª´a t·∫°o v√†o danh s√°ch node ch√≠nh
    fullKnowledgeData.nodes.push(...lessonNodes);
    
    // B∆∞·ªõc 3: T·∫°o t·∫•t c·∫£ c√°c link m·ªôt c√°ch ch√≠nh x√°c
    const nodeMap = new Map(fullKnowledgeData.nodes.map(node => [node.id, node]));
    const linkTracker = new Set(); // D√πng Set ƒë·ªÉ theo d√µi c√°c link ƒë√£ ƒë∆∞·ª£c th√™m

    // 3.1: T·∫°o link PH√ÇN R√É t·ª´ Ch∆∞∆°ng -> B√†i h·ªçc
    fullKnowledgeData.nodes.forEach(node => {
      if (node.type === 'lesson' && node.parentChapter && nodeMap.has(node.parentChapter)) {
        fullKnowledgeData.links.push({
          source: node.parentChapter,
          target: node.id,
          type: 'sub_knowledge'
        });
      }
    });

    // 3.2: Duy·ªát qua T·∫§T C·∫¢ c√°c node ƒë·ªÉ t·∫°o link quan h·ªá
    fullKnowledgeData.nodes.forEach(node => {
      if (node.type === 'chapter') {
        // X·ª≠ l√Ω TI√äN QUY·∫æT (M≈©i t√™n ƒëi v√†o node hi·ªán t·∫°i)
        if (node.prerequisites) {
          node.prerequisites.forEach(prereqId => {
            const linkKey = `${prereqId} -> ${node.id}`; // T·∫°o m·ªôt key duy nh·∫•t cho link
            if (nodeMap.has(prereqId) && !linkTracker.has(linkKey)) {
              fullKnowledgeData.links.push({
                source: prereqId,
                target: node.id,
                type: "relationship"
              });
              linkTracker.add(linkKey); // ƒê√°nh d·∫•u link n√†y ƒë√£ ƒë∆∞·ª£c th√™m
            }
          });
        }

        // X·ª≠ l√Ω ·ª®NG D·ª§NG (M≈©i t√™n ƒëi ra t·ª´ node hi·ªán t·∫°i)
        if (node.applications) {
          node.applications.forEach(appId => {
            const linkKey = `${node.id} -> ${appId}`; // T·∫°o m·ªôt key duy nh·∫•t cho link
            if (nodeMap.has(appId) && !linkTracker.has(linkKey)) {
              fullKnowledgeData.links.push({
                source: node.id,
                target: appId,
                type: "relationship"
              });
              linkTracker.add(linkKey); // ƒê√°nh d·∫•u link n√†y ƒë√£ ƒë∆∞·ª£c th√™m
            }
          });
        }
      }
    });

    // ===== H·ªÜ TH·ªêNG M√ÄU S·∫ÆC =====
    // ‚ú® UPDATE: Thay ƒë·ªïi m√†u trung t√≠nh ƒë·ªÉ h√≤a v√†o n·ªÅn t·ªët h∆°n
    const NEUTRAL_COLOR = 'rgba(50, 60, 100, 0.2)';
    const PREREQUISITE_COLOR = '#ff6961';
    const APPLICATION_COLOR = '#77dd77';
    const SUB_KNOWLEDGE_COLOR = '#6CA0DC';

    // ===== TR·∫†NG TH√ÅI =====
    let selectedNode = null;
    let hoveredNode = null;
    let highlightNodes = new Set();
    let highlightLinks = new Set();
    let isNodeSelected = false;

    // C·∫≠p nh·∫≠t th·ªëng k√™
    const chapterCount = fullKnowledgeData.nodes.filter(n => n.type === 'chapter').length;
    document.getElementById('total-chapters').textContent = chapterCount;
    document.getElementById('total-links').textContent = fullKnowledgeData.links.length;

    // ===== H√ÄM T√çNH ƒê·ªò D√ÄY LINK =====
    function calculateLinkWidth(link) {
      if (link.type === 'sub_knowledge') {
        return 1;
      }
      
      const sourceNode = fullKnowledgeData.nodes.find(n => n.id === (link.source.id || link.source));
      const targetNode = fullKnowledgeData.nodes.find(n => n.id === (link.target.id || link.target));
      
      if (sourceNode && targetNode && sourceNode.type === 'chapter' && targetNode.type === 'chapter') {
        const importance = (sourceNode.val + targetNode.val) / 6;
        return Math.max(2, Math.min(5, importance));
      }
      
      return 2;
    }

    // ===== H√ÄM X√ÅC ƒê·ªäNH M√ÄU LINK =====
    function getLinkColor(link) {
        const sourceId = link.source.id || link.source;
        const targetId = link.target.id || link.target;
        const currentNodeId = selectedNode ? selectedNode.id : (hoveredNode ? hoveredNode.id : null);

        // Gi·ªØ nguy√™n m√†u cho c√°c link m·∫∑c ƒë·ªãnh v√† link ph√¢n r√£
        if (!currentNodeId || !highlightLinks.has(link)) {
            if (link.type === 'sub_knowledge') return SUB_KNOWLEDGE_COLOR;
            return NEUTRAL_COLOR;
        }
        if (link.type === 'sub_knowledge') return SUB_KNOWLEDGE_COLOR;

        // Logic t√¥ m√†u th√¥ng minh
        const sourceNode = nodeMap.get(sourceId);
        const targetNode = nodeMap.get(targetId);

        if (sourceNode && targetNode) {
            // M√ÄU ƒê·ªé (Ti√™n quy·∫øt): Khi node ƒë∆∞·ª£c ch·ªçn l√† ƒê√çCH, v√† node ƒê√çCH c√≥ khai b√°o node NGU·ªíN l√† ti√™n quy·∫øt.
            if (currentNodeId === targetId && targetNode.prerequisites && targetNode.prerequisites.includes(sourceId)) {
            return PREREQUISITE_COLOR;
            }
            
            // M√ÄU XANH (·ª®ng d·ª•ng): Khi node ƒë∆∞·ª£c ch·ªçn l√† NGU·ªíN, v√† node NGU·ªíN c√≥ khai b√°o node ƒê√çCH l√† ·ª©ng d·ª•ng.
            if (currentNodeId === sourceId && sourceNode.applications && sourceNode.applications.includes(targetId)) {
            return APPLICATION_COLOR;
            }
        }
        
        // N·∫øu kh√¥ng r∆°i v√†o c√°c tr∆∞·ªùng h·ª£p tr√™n, n√≥ l√† m·ªôt li√™n k·∫øt c√≥ li√™n quan nh∆∞ng kh√¥ng tr·ª±c ti·∫øp -> m√†u trung t√≠nh.
        return NEUTRAL_COLOR;
        }
    
    
        // ===== KH·ªûI T·∫†O GRAPH =====
    const Graph = ForceGraph3D()
      (document.getElementById('graph-container'))
        .backgroundColor('#0a0e27')
        .graphData(fullKnowledgeData)
        .nodeLabel(node => node.type === 'lesson' ? node.name : node.id)
        .nodeVal('val')
        .nodeThreeObject(node => {
            const group = new THREE.Group();
            
            // T·ªêI ∆ØU H√ìA: Gi·∫£m ƒë·ªô ph·ª©c t·∫°p c·ªßa Geometry
            const geometry = new THREE.SphereGeometry(node.val, 16, 16); 
            
            // Kh√¥ng c·∫ßn thay ƒë·ªïi ph·∫ßn material
            const material = new THREE.MeshPhongMaterial({
                color: node.color,
                emissive: node.color,
                emissiveIntensity: 0.4,
                shininess: 100,
                specular: 0x444444,
                transparent: true,
                opacity: 0.95
            });
            const sphere = new THREE.Mesh(geometry, material);
            group.add(sphere);

            // --- S·ª¨A L·ªñI FONT V√Ä X·ª¨ L√ù TEXT D√ÄI ---
            if (node.type === 'chapter' || node.type === 'lesson') {
                const text = node.type === 'chapter' ? node.id : node.name;
                
                // T·ª± ƒë·ªông ng·∫Øt d√≤ng cho text d√†i
                const wrapText = (text, maxWidth) => {
                    if (text.length <= maxWidth) return text;
                    const words = text.split(' ');
                    let lines = [];
                    let currentLine = words[0];
                    for (let i = 1; i < words.length; i++) {
                        if (currentLine.length + words[i].length + 1 <= maxWidth) {
                            currentLine += ' ' + words[i];
                        } else {
                            lines.push(currentLine);
                            currentLine = words[i];
                        }
                    }
                    lines.push(currentLine);
                    return lines.join('\n'); // K√Ω t·ª± \n ƒë·ªÉ xu·ªëng d√≤ng
                };

                const wrappedText = node.type === 'chapter' ? wrapText(text, 25) : text; // Ch·ªâ ng·∫Øt d√≤ng cho t√™n ch∆∞∆°ng

                const sprite = new SpriteText(wrappedText);
                sprite.fontFace = 'Arial'; // Ch·ªâ ƒë·ªãnh r√µ r√†ng font Arial
                sprite.fontWeight = 'bold';

                if (node.type === 'chapter') {
                    sprite.textHeight = 6;
                    sprite.position.y = node.val + 8;
                } else { // lesson
                    sprite.textHeight = 3;
                    sprite.position.y = node.val + 4;
                }
                
                sprite.color = node.type === 'chapter' ? '#ffffff' : '#cccccc';
                group.add(sprite);
            }
            
            return group;
        })
        .linkColor(link => getLinkColor(link))
        .linkWidth(link => {
          const baseWidth = calculateLinkWidth(link);
          if (highlightLinks.size === 0) return baseWidth;
          return highlightLinks.has(link) ? baseWidth * 1.5 : baseWidth * 0.3;
        })
        .linkDirectionalArrowLength(link => {
          if (link.type === 'sub_knowledge') return 3;
          if (highlightLinks.size === 0) return 6;
          return highlightLinks.has(link) ? 8 : 4;
        })
        .linkDirectionalArrowRelPos(1)
        .linkDirectionalArrowColor(link => getLinkColor(link))
        .linkOpacity(link => {
          if (highlightLinks.size === 0) return 0.6;
          return highlightLinks.has(link) ? 0.9 : 0.1;
        })
        .linkCurvature(0.2)
        .linkDirectionalParticles(link => {
          return (highlightLinks.has(link) && link.type !== 'sub_knowledge') ? 4 : 0;
        })
        .linkDirectionalParticleWidth(3)
        .linkDirectionalParticleSpeed(0.006)
        .onNodeHover(node => {
          if (!isNodeSelected) {
            hoveredNode = node;
            if (node && node.type === 'chapter') {
              highlightNodeConnections(node, false);
            } else {
              clearHighlight();
            }
          }
        })
        .onNodeClick(node => {
          if (node.type === 'chapter') {
            isNodeSelected = true;
            selectedNode = node;
            showNodeDetail(node);
            highlightNodeConnections(node, true);
          }
        })
        .onBackgroundClick(() => {
          closeDetail();
          clearHighlight();
          isNodeSelected = false;
          hoveredNode = null;
        });

    // C·∫•u h√¨nh l·ª±c
    Graph.d3Force('charge').strength(-400);
    Graph.d3Force('link').distance(link => link.type === 'sub_knowledge' ? 30 : 120);
    Graph.d3Force('center').strength(0.2);

    // L·ª±c ph√¢n t·∫ßng
    const layerForce = (alpha) => {
      fullKnowledgeData.nodes.forEach(node => {
        let targetY = 0;
        if (node.group === 12) targetY = 150;
        else if (node.group === 11) targetY = 0;
        else if (node.group === 10) targetY = -150;
        
        node.vy -= (node.y - targetY) * 0.8 * alpha;
        
        const maxDistance = 300;
        const dx = node.x;
        const dz = node.z;
        const distance = Math.sqrt(dx * dx + dz * dz);
        
        if (distance > maxDistance) {
          const scale = maxDistance / distance;
          node.vx -= (node.x - dx * scale) * 0.15;
          node.vz -= (node.z - dz * scale) * 0.15;
        }
        
        if (alpha < 0.01) {
          node.y = targetY;
          node.vy = 0;
        }
      });
    };
    Graph.d3Force('layering', layerForce);

    // Th√™m √°nh s√°ng v√† m·∫∑t ph·∫≥ng H√åNH TR√íN ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p
    setTimeout(() => {
      const scene = Graph.scene();
      
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight1.position.set(200, 200, 200);
      scene.add(directionalLight1);
      
      const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
      directionalLight2.position.set(-200, -200, -200);
      scene.add(directionalLight2);

      // ‚ú® UPDATE: H√†m t·∫°o m·∫∑t ph·∫≥ng v·ªõi hi·ªáu ·ª©ng gradient v√† v√≤ng s√°ng (glow)
      function createCirclePlane(y, label, color) {
        const radius = 400;
        const segments = 64;
        
        // 1. T·∫°o m·∫∑t ph·∫≥ng n·ªÅn v·ªõi gradient tinh t·∫ø
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = 512;
        canvas.height = 512;
        const gradient = context.createRadialGradient(256, 256, 0, 256, 256, 256);
        gradient.addColorStop(0, 'rgba(40, 50, 90, 0.3)'); // M√†u trung t√¢m
        gradient.addColorStop(1, 'rgba(20, 25, 45, 0.1)'); // M√†u r√¨a
        context.fillStyle = gradient;
        context.fillRect(0, 0, 512, 512);

        const planeTexture = new THREE.CanvasTexture(canvas);
        const planeMaterial = new THREE.MeshBasicMaterial({
            map: planeTexture,
            transparent: true,
            side: THREE.DoubleSide
        });
        const planeGeometry = new THREE.CircleGeometry(radius, segments);
        const circlePlane = new THREE.Mesh(planeGeometry, planeMaterial);
        circlePlane.position.set(0, y, 0);
        circlePlane.rotation.x = Math.PI / 2;
        scene.add(circlePlane);

        // 2. T·∫°o v√≤ng s√°ng (glow ring) b·∫±ng Torus v√† AdditiveBlending
        const ringGeometry = new THREE.TorusGeometry(radius, 2, 16, 100);
        const ringMaterial = new THREE.MeshBasicMaterial({
            color: color,
            blending: THREE.AdditiveBlending, // Hi·ªáu ·ª©ng glow
            transparent: true,
            opacity: 0.7
        });
        const ring = new THREE.Mesh(ringGeometry, ringMaterial);
        ring.position.set(0, y, 0);
        ring.rotation.x = Math.PI / 2;
        scene.add(ring);
        
        // 3. Gi·ªØ nguy√™n ph·∫ßn label
        const labelSprite = new SpriteText(label);
        labelSprite.color = '#FFFFFF';
        labelSprite.textHeight = 16;
        labelSprite.fontWeight = 'bold';
        labelSprite.position.set(radius - 50, y + 20, 0);
        scene.add(labelSprite);
      }

      createCirclePlane(150, 'To√°n 12 - T·ªïng h·ª£p & ·ª®ng d·ª•ng', 0xff8844);
      createCirclePlane(0, 'To√°n 11 - X√¢y d·ª±ng C√¥ng c·ª•', 0xffdd44);
      createCirclePlane(-150, 'To√°n 10 - N·ªÅn t·∫£ng', 0x8888ff);
    }, 100);

    // G√≥c nh√¨n m·∫∑c ƒë·ªãnh
    setTimeout(() => {
    Graph.cameraPosition(
        { x: 0, y: 350, z: 800 }, // <-- Gi√° tr·ªã m·ªõi: xa h∆°n (z=800), cao h∆°n (y=350), tr·ª±c di·ªán h∆°n (x=0)
        { x: 0, y: 0, z: 0 }, // Nh√¨n v√†o trung t√¢m
        1500 // TƒÉng th·ªùi gian chuy·ªÉn ƒë·ªông cho m∆∞·ª£t h∆°n
    );
    }, 500);

    // ===== H√ÄM HIGHLIGHT NODE CONNECTIONS =====
    function highlightNodeConnections(node, isPermanent) {
    highlightNodes.clear();
    highlightLinks.clear();

    if (node) {
        highlightNodes.add(node.id);
        
        fullKnowledgeData.links.forEach(link => {
            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;
            
            if (sourceId === node.id || targetId === node.id) {
                highlightLinks.add(link);
                highlightNodes.add(sourceId);
                highlightNodes.add(targetId);
            }
        });
    }

    // --- THAY ƒê·ªîI L·ªöN: KH√îNG T√ÅI T·∫†O OBJECT, CH·ªà C·∫¨P NH·∫¨T THU·ªòC T√çNH ---
    Graph.graphData().nodes.forEach(n => {
        if (!n.__threeObj) return; // B·ªè qua n·∫øu ƒë·ªëi t∆∞·ª£ng 3D ch∆∞a ƒë∆∞·ª£c t·∫°o

        const isHighlighted = highlightNodes.has(n.id);
        const shouldBeVisible = isHighlighted || highlightNodes.size === 0;

        // C·∫≠p nh·∫≠t Sphere (qu·∫£ c·∫ßu)
        const sphere = n.__threeObj.children[0];
        if (sphere && sphere.material) {
            sphere.material.opacity = shouldBeVisible ? 0.95 : 0.15;
            sphere.material.emissiveIntensity = isHighlighted ? 0.4 : 0.1;
        }
        
        // C·∫≠p nh·∫≠t Text (nh√£n)
        const sprite = n.__threeObj.children[1];
        if (sprite && sprite.material) {
             sprite.material.opacity = shouldBeVisible ? 1 : 0.2;
        }
    });

    // C·∫≠p nh·∫≠t m√†u s·∫Øc v√† thu·ªôc t√≠nh c·ªßa Link
    Graph.linkColor(Graph.linkColor())
         .linkWidth(Graph.linkWidth())
         .linkOpacity(Graph.linkOpacity())
         .linkDirectionalParticles(Graph.linkDirectionalParticles());
}

    function clearHighlight() {
    highlightNodes.clear();
    highlightLinks.clear();
    
    // ‚úÖ C·∫¨P NH·∫¨T C·∫¢ NODE V√Ä LINK
    Graph.nodeThreeObject(Graph.nodeThreeObject());
    Graph.linkColor(Graph.linkColor());
    Graph.linkDirectionalArrowColor(Graph.linkDirectionalArrowColor());
    }

    // ===== H√ÄM HI·ªÇN TH·ªä CHI TI·∫æT NODE =====
    function showNodeDetail(node) {
      if (node.type !== 'chapter') return;
      
      const detail = document.getElementById('node-detail');
      const content = document.getElementById('detail-content');
      
      const badge = `<span class="badge badge-${node.group}">L·ªõp ${node.group}</span>`;
      
      let prerequisitesHTML = '';
      if (node.prerequisites && node.prerequisites.length > 0) {
        prerequisitesHTML = '<h3>üî¥ Ki·∫øn th·ª©c ti√™n quy·∫øt:</h3><ul>';
        node.prerequisites.forEach(prereq => {
          prerequisitesHTML += `<li>${prereq}</li>`;
        });
        prerequisitesHTML += '</ul>';
      }
      
      let applicationsHTML = '';
      if (node.applications && node.applications.length > 0) {
        applicationsHTML = '<h3>üü¢ Ki·∫øn th·ª©c ·ª©ng d·ª•ng:</h3><ul>';
        node.applications.forEach(app => {
          applicationsHTML += `<li>${app}</li>`;
        });
        applicationsHTML += '</ul>';
      }
      
      let lessonsHTML = '<h3>üìñ C√°c b√†i h·ªçc:</h3><ul>';
      if (node.lessons) {
        node.lessons.forEach(lesson => {
          lessonsHTML += `<li>${lesson}</li>`;
        });
      }
      lessonsHTML += '</ul>';
      
      content.innerHTML = `
        <h2>${badge} ${node.id}</h2>
        <p style="color: #aaa; font-size: 11px; margin-bottom: 10px;">${node.description || ''}</p>
        ${prerequisitesHTML}
        ${applicationsHTML}
        ${lessonsHTML}
      `;
      
      detail.classList.add('active');
    }

    function closeDetail() {
      document.getElementById('node-detail').classList.remove('active');
      selectedNode = null;
    }

    function searchNode(query) {
      if (!query) {
        clearHighlight();
        isNodeSelected = false;
        hoveredNode = null;
        closeDetail();
        return;
      }
      
      const found = fullKnowledgeData.nodes.find(node => 
        node.type === 'chapter' && node.id.toLowerCase().includes(query.toLowerCase())
      );
      
      if (found) {
        isNodeSelected = true;
        highlightNodeConnections(found, true);
        showNodeDetail(found);
        Graph.cameraPosition(
          { x: found.x + 100, y: found.y + 50, z: found.z + 100 },
          { x: found.x, y: found.y, z: found.z },
          1000
        );
      }
    }

    

    function viewAngle() {
        Graph.cameraPosition(
            { x: 0, y: 350, z: 800 },
            { x: 0, y: 0, z: 0 },
            1000
        );
        }

    function viewTop() {
      Graph.cameraPosition(
        { x: 0, y: 600, z: 0 },
        { x: 0, y: 0, z: 0 },
        1000
      );
    }

    function viewSide() {
      Graph.cameraPosition(
        { x: 600, y: 0, z: 0 },
        { x: 0, y: 0, z: 0 },
        1000
      );
    }

    function resetView() {
      clearHighlight();
      closeDetail();
      isNodeSelected = false;
      hoveredNode = null;
      document.getElementById('search-input').value = '';
      viewAngle();
    }

    let physicsEnabled = true;
    function togglePhysics() {
      physicsEnabled = !physicsEnabled;
      if (physicsEnabled) {
        Graph.d3ReheatSimulation();
      } else {
        Graph.d3AlphaDecay(1);
      }
    }
  </script>
</body>
</html>